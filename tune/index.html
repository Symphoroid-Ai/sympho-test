<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>sympho tune</title>
  <script src="https://www.youtube.com/iframe_api"></script>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: 'Comfortaa', 'Helvetica Neue', 'Segoe UI', sans-serif;
      background-color:  #0d1b2a;
      color: white;
    }
    header, section {
      padding: 2em;
      text-align: center;
    }
    h1 {
      font-size: clamp(1.5rem, 5vw, 3rem);
    }
    #langToggle {
      position: absolute;
      top: 1rem;
      right: 1rem; 
      background: #00bcd4;
      color: white;
      border: 1px solid white;
      border-radius: 5px;
      padding: 0.5rem 1rem;
      z-index: 10;
      cursor: pointer;
      font-size: 1rem;
    }
    .btn {
      background: #00bcd4;
      border: none;
      padding: 0.8em 1.5em;
      margin: 0.5em;
      color: white;
      border: 1px solid white;      
      font-size: 1em;
      border-radius: 5px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease;
      position: relative;
      z-index: 1;
    }
    .btn:active{
      transform: scale(1.05);
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
    }
    .btn.pop {
      animation: popGlow 0.25s ease forwards;
    }
    @keyframes popGlow {
      0% { transform: scale(1); box-shadow:0 0 0 rgba(255,255,255,0); background-color: inherit; color: inherit; }
      30% { transform: scale(1.3); box-shadow: 0 0 20px rgba(255,255,255,0.8),0 0 40px rgba(0,188,212,0.5); }
      60% { transform: scale(1.1); box-shadow:0 0 15px rgba(255,255,255,0.6),0 0 30px rgba(0,188,212,0.4); background-color: #00e0ff; color: #fff;}
      100% { transform: scale(1); box-shadow:0 0 0 rgba(255,255,255,0); background-color:#00bcd4; color:white; }
    }
    iframe { display: block; border: none; }
    #videoArea_loop { position: relative; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    section h2 { font-size: clamp(1rem, 5vw, 1.5rem); margin-bottom: 20px; }
    .section-button { padding: 12px 25px; font-weight: bold; color: white; background-color: #FF0000; text-decoration: none; border-radius: 6px; }
    header { background-color: #EAEEF6; color: #01BEE3; }
    .sns-links a { color: #7FDBFF; text-decoration: none; font-size: 32px; margin: 0 10px; }
    .sns-links a:hover { color: #00bcd4; }
    .footer-links { margin: 0 5px; text-decoration: none; color: inherit; font-size: 0.9rem; }
    .footer-links:hover { text-decoration: underline; }
    footer { text-align: center; padding: 20px; }
    .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    #timerDisplay {
      position: absolute;
      font-size: 2em;
      color: #ffffff;
      z-index: 10;
      pointer-events: none;
      text-shadow:0 0 10px rgba(200,230,255,0.9),0 0 18px rgba(120,180,255,0.6);
      background: rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 0.35em 0.7em;
      backdrop-filter: blur(12px);
      box-shadow:0 0 18px rgba(255,255,255,0.45),0 0 30px rgba(135,206,250,0.35),0 6px 25px rgba(0,0,0,0.45);
    }
    header img, .responsive-img { max-width:600px; width:80%; height:auto; display:block; margin:0 auto; }
    .top-left { top: 10px; left: 10px; }
    .top-right { top: 10px; right: 10px; }
    .bottom-left { bottom: 10px; left: 10px; }
    .bottom-right { bottom: 10px; right: 10px; }
    .center { top: 50%; left: 50%; transform: translate(-50%,-50%); }
    .simple-center { top:50%; left:50%; transform:translate(-50%,-50%);}
    .loop-controls, .upper-controls, .lower-controls, .btn-group { display:flex; flex-direction:column; align-items:center; gap:0.5em; justify-content:center; }
    .lower-controls { flex-direction:row; margin-top:1em; }
    #videoArea_choice { scroll-margin-top:80px; }
    .video-wrapper { position: relative; width:100%; max-width:800px; padding-bottom:56.25%; margin:auto; height:0; overflow:hidden; scroll-margin-top:80px; }
    .video-wrapper.empty { padding-bottom:0; height:0; min-height:0; margin:0; }
    .time-input { display:flex; align-items:center; gap:0.5em; }
    .time-input input { padding:0.5em; width:100px; }

    /* ---------------- å††å½¢ã‚¿ã‚¤ãƒãƒ¼ ---------------- */
    .circular-timer {
      position: absolute;
      top: 50%;
      left: 50%;
      height: auto;
      width: 50%;        /* å††ã‚’å¤§ãã */
      max-width: 600px;  /* æœ€å¤§ã‚µã‚¤ã‚º */
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 15;
    }
    
    #circularTimer {
      position: absolute;
      width: 100%;
      height: auto;
      pointer-events: none;
      display: none;
    }
    
    .circular-timer svg {
      width: 50%;
      height:auto%;
      max-width: 600px; 
      overflow: visible;
      display: block;
      transform: none;   /* å›è»¢ã‚’å‰Šé™¤ */
    }
    
    .circular-timer circle {
      fill: none;
      stroke-linecap: round;
    }
    
    .circular-timer .bg {
      stroke: rgba(255,255,255,0.2);
    }
    
    .circular-timer .progress {
      stroke: #ff0000;
      transition: stroke-dashoffset 1s linear;
      transform-origin: 50% 50%;
    }
    
    .circular-timer svg text {
      font-size: 2.5em;           /* æ•°å­—ã‚’å¤§ãã */
      fill: white;
      text-anchor: middle;         /* æ¨ªä¸­å¤® */
      dominant-baseline: middle;   /* ç¸¦ä¸­å¤® */
      pointer-events: none;
      transform: none;             /* å›è»¢å‰Šé™¤ */
      text-shadow: 0 0 6px rgba(0,0,0,0.6),
                   0 0 12px rgba(255,255,255,0.3); /* ã‚·ãƒ£ãƒ‰ã‚¦ã§è¦‹ã‚„ã™ã */
    }

  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DC85V6L5MK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-DC85V6L5MK');
  </script>
</head>
<body>

<header>
  <button id="langToggle" class="btn">English</button>
  <img src="Symphotune.png" alt="sympho tune logo" class="responsive-img" />
  <h1 data-jp="å¿ƒã¨æ™‚é–“ã«å¯„ã‚Šæ·»ã†ã€ç™’ã—ã®éŸ³æ¥½ä½“é¨“ã€‚" data-en="Soothing music that cares for your heart and time."></h1>
  <p data-jp="Focus your time. Tune your mind." data-en="Focus your time. Tune your mind."></p>
  <button class="btn" onclick="showSection('choice')" data-jp="æ°—åˆ†ã§éŸ³æ¥½ã‚’é¸ã¶" data-en="Pick music by mood"></button>
  <button class="btn" onclick="showSection('loop')" data-jp="å‹•ç”»ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’ã¤ã‘ã‚‹" data-en="Attach timer to video"></button>
</header>

<section id="choice" style="display:none;">
  <img src="Symphochoice.png" alt="æ°—åˆ†ã§éŸ³æ¥½ã‚’é¸ã¶ã‚¤ãƒ¡ãƒ¼ã‚¸" class="responsive-img" />
  <h2 data-jp="ä»Šæ—¥ã®æ°—åˆ†ã«ã´ã£ãŸã‚Šã®éŸ³æ¥½ã‚’ã€‚" data-en="Music that fits your mood today."></h2>
  <p data-jp="é¸ã‚“ã æ°—åˆ†ã«åˆã‚ã›ã¦ã€Symphoroid Aiã®ç™’ã—éŸ³æ¥½ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚" data-en="Choose your mood, and Symphoroid Ai will bring you calming music to match."></p>
  <br><br>
  <p data-jp="ä»Šæ—¥ã®æ°—åˆ†ã¯ï¼Ÿ" data-en="How do you feel today?"></p>
  <div>
    <button class="btn" onclick="playRandomVideo('å…ƒæ°—')" data-mood="å…ƒæ°—" data-jp="å…ƒæ°—" data-en="Energetic">å…ƒæ°—</button>
    <button class="btn" onclick="playRandomVideo('ç™’ã—')" data-mood="ç™’ã—" data-jp="ç™’ã—" data-en="Healing">ç™’ã—</button>
    <button class="btn" onclick="playRandomVideo('é›†ä¸­')" data-mood="é›†ä¸­" data-jp="é›†ä¸­" data-en="Focus">é›†ä¸­</button>
    <button class="btn" onclick="playRandomVideo('åˆ‡ãªã„')" data-mood="åˆ‡ãªã„" data-jp="åˆ‡ãªã„" data-en="Melancholy">åˆ‡ãªã„</button>
    <button class="btn" onclick="playRandomVideo('ãŠã‚„ã™ã¿')" data-mood="ãŠã‚„ã™ã¿" data-jp="ãŠã‚„ã™ã¿ğŸŒ™" data-en="BedtimeğŸŒ™">ãŠã‚„ã™ã¿</button>
    <button class="btn" onclick="playRandomVideo('ãƒ­ãƒƒã‚¯')" data-mood="ãƒ­ãƒƒã‚¯" data-jp="ãƒ­ãƒƒã‚¯ğŸ¸" data-en="RockğŸ¸">ãƒ­ãƒƒã‚¯</button>       
  </div>
  <div id="videoArea_choice"></div>
</section>

<section id="loop" style="display:none;">
  <img src="Sympholoop.png" alt="ã‚¿ã‚¤ãƒãƒ¼ä»˜ãå‹•ç”»ã®ä¾‹" class="responsive-img" />
  <h2 data-jp="å¥½ããªå‹•ç”»ã‚’ã€ã†é›†ä¸­ã‚¿ã‚¤ãƒ ã«ã€‚" data-en="Turn your favorite videos into focus time."></h2>
  <p data-jp="ã‚¿ã‚¤ãƒãƒ¼ã¨ç¹°ã‚Šè¿”ã—å†ç”Ÿã§ã€ä½œæ¥­ç”¨å‹•ç”»ã‚’ã‚‚ã£ã¨è‡ªåˆ†ä»•æ§˜ã«ã€‚" data-en="Customize your work videos with a timer and loop playback."></p>

<div class="upper-controls">
  <input type="text" id="ytUrl" placeholder="YouTubeå‹•ç”»ã®URLã‚’å…¥åŠ›" style="width:80%; padding:0.5em;" data-jp="YouTubeå‹•ç”»ã®URLã‚’å…¥åŠ›" data-en="Enter YouTube video URL">
  
  <div class="time-input">
    <input type="number" id="duration" placeholder="æ™‚é–“" value="10" data-jp="æ™‚é–“" data-en="Duration">
    <span data-jp="åˆ†" data-en="min">åˆ†</span>
  </div>
  
  <div class="btn-group">
    <button class="btn" onclick="toggleTimerPosition()" id="positionBtn" data-jp="è¡¨ç¤ºä½ç½®ï¼šå·¦ä¸Š" data-en="Position: Top-Left"></button>
    <button class="btn" onclick="loadVideo()" data-jp="å‹•ç”»ã¨ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆ" data-en="Set Video & Timer"></button>
    <button class="btn" onclick="resetLoop()" data-jp="ãƒªã‚»ãƒƒãƒˆ" data-en="Reset"></button>
    <button class="btn" onclick="toggleTimerType()" id="timerTypeBtn" data-jp="ã‚·ãƒ³ãƒ—ãƒ«ã‚¿ã‚¤ãƒãƒ¼" data-en="Simple Timer"></button>
  </div>
</div>

<div class="video-wrapper">
  <div id="ytPlayer"></div>
  <div id="timerDisplay" class="top-left" style="display:none;"></div>
</div>

<div class="lower-controls">
  <button class="btn" onclick="playLoop()" data-jp="å†ç”Ÿ" data-en="Play"></button>
  <button class="btn" onclick="stopLoop()" data-jp="ã‚¹ãƒˆãƒƒãƒ—" data-en="Stop"></button>
</div>
</section>

<footer>
  <p class="sns-links">
    <a href="https://www.youtube.com/@symphoroidai" target="_blank"><i class="fab fa-youtube"></i></a>
    <a href="https://www.instagram.com/symphoroid_ai" target="_blank"><i class="fab fa-instagram"></i></a>
    <a href="https://www.tiktok.com/@symphoroid.ai" target="_blank"><i class="fab fa-tiktok"></i></a>
    <a href="https://www.x.com/@SymphoroidAi" target="_blank"><i class="fab fa-x-twitter"></i></a>
  </p>
  <p>&copy; 2025 Sympho tune - powered by Symphoroid Ai</p>
  <br>
  <a href="../terms.html" data-jp="åˆ©ç”¨è¦ç´„" data-en="Terms of Use" class="footer-links">åˆ©ç”¨è¦ç´„</a> |
  <a href="../privacy.html" data-jp="ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼" data-en="Privacy Policy" class="footer-links">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a> |
  <a href="../" data-jp="ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸" data-en="Home" class="footer-links">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a>  
  <p class="lang-text" data-jp="æ¬¡ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®æœ€æ–°ç‰ˆã‚’ã”åˆ©ç”¨ãã ã•ã„..." data-en="We recommend using the latest version of one of the following browsers..."></p>
</footer>

<script>
let ytPlayer, timerInterval;
let remainingTime = 0;
let isPaused = false, isPlaying = false;
let playerReady = false;
let isCircular = false; // è¿½åŠ ï¼šå††å½¢ã‚¿ã‚¤ãƒãƒ¼ã®åˆæœŸçŠ¶æ…‹

const positions = ["top-left", "top-right", "bottom-left", "bottom-right", "center"];
let positionIndex = 0;

let currentLang = localStorage.getItem('lang') || 'jp'; // â† localStorageã‹ã‚‰èª­ã¿è¾¼ã¿

document.addEventListener("DOMContentLoaded", () => {
  // ä¿å­˜ã•ã‚Œã¦ã„ãŸæ™‚é–“ã‚’å¾©å…ƒ
  const saved = localStorage.getItem("savedDuration");
  if (saved) {
    document.getElementById("duration").value = saved;
  }

  // è¨€èªå‡¦ç†
  updateLanguage();
  document.getElementById("langToggle").textContent = currentLang === 'jp' ? "English" : "æ—¥æœ¬èª";
  checkYTApiReady();

  // æ™‚é–“å…¥åŠ›æ™‚ã«ä¿å­˜ã™ã‚‹
  document.getElementById("duration").addEventListener("input", function () {
    localStorage.setItem("savedDuration", this.value);
  });
});
  
document.getElementById("langToggle").addEventListener("click", () => {
  currentLang = currentLang === 'jp' ? 'en' : 'jp';
  localStorage.setItem('lang', currentLang); // â† è¨€èªã‚’ä¿å­˜
  updateLanguage();
  document.getElementById("langToggle").textContent = currentLang === 'jp' ? "English" : "æ—¥æœ¬èª";
});

function updateLanguage() {
  document.querySelectorAll("[data-jp]").forEach(el => {
    if ('placeholder' in el) {
      el.placeholder = el.getAttribute(`data-${currentLang}`);
    } else {
      el.textContent = el.getAttribute(`data-${currentLang}`);
    }
  });
}

function showSection(section) {
  document.getElementById("choice").style.display = section === "choice" ? "block" : "none";
  document.getElementById("loop").style.display = section === "loop" ? "block" : "none";
  setTimeout(() => {
    document.getElementById(section).scrollIntoView({ behavior: "smooth" });
  }, 100);
}

// --- ä½ç½®åˆ‡æ›¿ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã‚¿ã‚¤ãƒãƒ¼ã¨å††å½¢ã‚¿ã‚¤ãƒãƒ¼åˆ†é›¢ï¼‰ ---
function toggleTimerPosition(){
  positionIndex = (positionIndex+1)%positions.length;
  const posLabels = currentLang==='jp'?["å·¦ä¸Š","å³ä¸Š","å·¦ä¸‹","å³ä¸‹","ä¸­å¤®"]:["Top-Left","Top-Right","Bottom-Left","Bottom-Right","Center"];

  const timerDisplay = document.getElementById("timerDisplay");
  // ã‚·ãƒ³ãƒ—ãƒ«ã‚¿ã‚¤ãƒãƒ¼ã®ã¿ã‚¯ãƒ©ã‚¹å¤‰æ›´
  if(!isCircular){
    timerDisplay.className = positions[positionIndex];
  }

  document.getElementById("positionBtn").textContent = (currentLang==='jp'?"è¡¨ç¤ºä½ç½®ï¼š":"Position: ") + posLabels[positionIndex];

  // å††å½¢ã‚¿ã‚¤ãƒãƒ¼ã«ã¯ä¸€åˆ‡è§¦ã‚Œãªã„
}


function toggleTimerType() {
  isCircular = !isCircular;
  const btn = document.getElementById("timerTypeBtn");
  btn.textContent = (isCircular ? (currentLang==='jp'?"ä½“æ„Ÿã‚¿ã‚¤ãƒãƒ¼":"Circular") : (currentLang==='jp'?"ã‚·ãƒ³ãƒ—ãƒ«ã‚¿ã‚¤ãƒãƒ¼":"Simple Timer"));

  const numericTimer = document.getElementById("timerDisplay");
  let circularTimer = document.getElementById("circularTimer"); // â† ã“ã“ã§æ¯å›å–å¾—
  if(isCircular){
    numericTimer.style.display = "none";
    if(!circularTimer) {
      createCircularTimer();
      circularTimer = document.getElementById("circularTimer"); // â† ä½œæˆå¾Œã«å†å–å¾—
    }
    // Ensure circular timer uses current position class (so "center" works)
    circularTimer.className = "circular-timer " + positions[positionIndex];
    circularTimer.style.display = "flex";
    // initialize text immediately
    const circularText = document.getElementById("circularTimerText");
    if (circularText) {
      const mins = String(Math.floor(remainingTime / 60)).padStart(2, '0');
      const secs = String(remainingTime % 60).padStart(2, '0');
      circularText.textContent = `${mins}:${secs}`;
    }
  } else {
    numericTimer.style.display = remainingTime>0 ? "block" : "none";
    if(circularTimer) circularTimer.style.display = "none";
  }
}

function createCircularTimer(){
  const wrapper = document.querySelector("#loop .video-wrapper");
  const div = document.createElement("div");
  div.id = "circularTimer";
  div.className = "circular-timer";

 div.innerHTML = `
  <svg viewBox="0 0 200 200">
    <circle class="bg" cx="100" cy="100" r="90"
        stroke="#ffffff33" stroke-width="12" fill="none" />
    <circle class="progress" cx="100" cy="100" r="90"
        stroke="#00eaff" stroke-width="12" fill="none"
        transform="rotate(-90 100 100)"
        style="stroke-linecap: round; transition: stroke-dashoffset 0.1s linear;" />
    <text id="circularTimerText"
          x="100" y="100"
          text-anchor="middle"
          dominant-baseline="central"
          fill="white"
          font-size="42"
          style="text-shadow: 0 0 8px black;">
      00:00
    </text>
  </svg>
`;
  wrapper.appendChild(div);

  // circumference è¨ˆç®—
  const progress = div.querySelector('.progress');
  const r = parseFloat(progress.getAttribute('r')); // 38
  const circ = 2 * Math.PI * r;
  progress.style.strokeDasharray = circ;
  progress.style.strokeDashoffset = circ;
  
  div.dataset.circumference = circ;
  div.dataset.r = r;

  // ensure initial stroke widths/appearance (optional but stabilizes rendering)
  const bg = div.querySelector('.bg');
  if(bg) {
    bg.setAttribute('stroke-width', 6);
  }
  if(progress) {
    progress.setAttribute('stroke-width', 6);
  }
}

function updateTimerDisplay(){
  if(isCircular){
    const circular = document.getElementById("circularTimer");
    if(!circular) return;
    const circle = circular.querySelector(".progress");
    const text = document.getElementById("circularTimerText");
    const total = parseInt(document.getElementById("duration").value,10)*60 || 1;
    const circ = parseFloat(circular.dataset.circumference) || parseFloat(circle.style.strokeDasharray) || 314;
    // progress as fraction (0..1) completed
    const progressFraction = (total - remainingTime) / total;
    // strokeDashoffset: circ when 0% completed, 0 when 100% completed
    const offset = Math.max(0, circ * (1 - progressFraction));
    circle.style.strokeDashoffset = offset;
    const mins = String(Math.floor(remainingTime/60)).padStart(2,'0');
    const secs = String(remainingTime%60).padStart(2,'0');
    if(text) text.textContent = `${mins}:${secs}`;
  } else {
    const timerDisplay = document.getElementById("timerDisplay");
    const mins = String(Math.floor(remainingTime/60)).padStart(2,'0');
    const secs = String(remainingTime%60).padStart(2,'0');
    timerDisplay.textContent = `${mins}:${secs}`;
  }
}

// YouTube APIãŒæ—¢ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ã—ã€playerReadyã‚’è¨­å®š
function checkYTApiReady() {
  if (window.YT && window.YT.Player) {
    playerReady = true;
    console.log("YouTube IFrame API is already loaded.");
  } else {
    setTimeout(checkYTApiReady, 200);
  }
}

// YouTube APIèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å¿…ãšå‘¼ã°ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
window.onYouTubeIframeAPIReady = function() {
  playerReady = true;
  console.log("YouTube IFrame API ready (callback).");
};

function loadVideo() {
  console.log("=== loadVideo triggered ===");

  const url = document.getElementById("ytUrl").value;
  const videoId = url.match(/(?:youtu\.be\/|v=)([a-zA-Z0-9_-]+)/)?.[1];
  if (!videoId) {
    alert(currentLang === 'jp' ? "æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" : "Please enter a valid URL.");
    return;
  }

const minutesInput = document.getElementById("duration").value.trim();

// æ•°å€¤ã‹ã©ã†ã‹ã€æ•´æ•°ã‹ã©ã†ã‹ã€1ä»¥ä¸Šã‹ã©ã†ã‹ã‚’ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯
if (!/^\d+$/.test(minutesInput)) {
  alert(currentLang === 'jp'
    ? "ã‚¿ã‚¤ãƒãƒ¼ã«ã¯1åˆ†ä»¥ä¸Šã®æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
    : "Please set the timer to an integer value of at least 1 minute.");
  return;
}

const minutes = parseInt(minutesInput, 10);
if (minutes <= 0) {
  alert(currentLang === 'jp'
    ? "ã‚¿ã‚¤ãƒãƒ¼ã«ã¯1åˆ†ä»¥ä¸Šã®æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
    : "Please set the timer to an integer value of at least 1 minute.");
  return;
}
  
  // ã‚¿ã‚¤ãƒãƒ¼åˆæœŸåŒ–
  remainingTime = minutes * 60;
  clearInterval(timerInterval);
  isCounting = false;

  // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã®æ›´æ–°
  const timerDisplay = document.getElementById("timerDisplay");
  // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã®æ›´æ–°
if (isCircular) {
  // æ•°å­—ã‚¿ã‚¤ãƒãƒ¼ã¯éè¡¨ç¤º
  timerDisplay.style.display = "none";

  // å††å½¢ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½œæˆ or è¡¨ç¤º
  let circularTimer = document.getElementById("circularTimer");
  if (!circularTimer) createCircularTimer();
  circularTimer = document.getElementById("circularTimer");
  // ensure it uses the current position class
  circularTimer.className = "circular-timer " + positions[positionIndex];
  circularTimer.style.display = "flex";

  // å††å½¢ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæœŸåŒ–
  const circularText = document.getElementById("circularTimerText");
  const mins = String(Math.floor(remainingTime / 60)).padStart(2, '0');
  const secs = String(remainingTime % 60).padStart(2, '0');
  if (circularText) circularText.textContent = `${mins}:${secs}`;

  // å††å½¢ã‚¿ã‚¤ãƒãƒ¼ã®ã‚²ãƒ¼ã‚¸ã‚‚ãƒªã‚»ãƒƒãƒˆ (use stored circumference)
  const progressCircle = circularTimer.querySelector(".progress");
  const total = parseInt(document.getElementById("duration").value, 10) * 60 || 1;
  const circ = parseFloat(circularTimer.dataset.circumference) || 314;
  progressCircle.style.strokeDashoffset = circ * 1; // start at 0 progress
  progressCircle.style.strokeDasharray = circ;

} else {
  // æ•°å­—ã‚¿ã‚¤ãƒãƒ¼
  timerDisplay.className = positions[positionIndex];
  timerDisplay.style.display = remainingTime > 0 ? "block" : "none";
  const mins = String(Math.floor(remainingTime / 60)).padStart(2,'0');
  const secs = String(remainingTime % 60).padStart(2,'0');
  timerDisplay.textContent = `${mins}:${secs}`;
}

  const mins = Math.floor(remainingTime / 60);
  const secs = remainingTime % 60;
  timerDisplay.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ– or cue å‹•ç”»
  if (!ytPlayer && playerReady) {
    ytPlayer = new YT.Player('ytPlayer', {
      videoId,
      playerVars: { playsinline: 1, fs: 0 },
      events: {
        onReady: event => {
          event.target.unMute();
          event.target.cueVideoById(videoId);
        },
        onStateChange: evt => {
          if (evt.data === YT.PlayerState.ENDED) {
            setTimeout(() => {
              if (ytPlayer && typeof ytPlayer.seekTo === 'function') {
                ytPlayer.seekTo(0, true);// ç§’å˜ä½ï¼‹éŸ³å£°ç¶­æŒ
                ytPlayer.unMute();  // ã“ã“ã«è¿½åŠ 
                ytPlayer.playVideo();
              }
            }, 300); // å°‘ã—é…å»¶ã•ã›ã¦ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªå¾©å¸°ã‚’ä¿ƒã™
          }
        }
      }
    });
  } else if (ytPlayer && playerReady) {
    ytPlayer.cueVideoById(videoId);
  } else {
    console.log("YouTube Player not ready yet.");
  }

  isPaused = false;
  isPlaying = false;
  document.querySelector("#loop .video-wrapper").scrollIntoView({ behavior: "smooth" });  
}


function playLoop() {
  
  if (!ytPlayer || isPlaying) return;

  console.log("=== playLoop triggered ===");
  ytPlayer.unMute();
  ytPlayer.playVideo();

  startTimer(remainingTime || 0);
  isPaused = false;
}

function startTimer(totalTime) {
  if (isPlaying) return;
  isPlaying = true;
  clearInterval(timerInterval);

  // ã‚¿ã‚¤ãƒãƒ¼åˆæœŸè¡¨ç¤º
  if (remainingTime < 0) remainingTime = 0;
  updateTimerDisplay(); // â† ã“ã“ã§æ•°å­—ã‚’æœ€æ–°ã«

  timerInterval = setInterval(() => {
    if (--remainingTime < 0) {
      clearInterval(timerInterval);
      remainingTime = 0; // 0ã§å›ºå®š
      updateTimerDisplay(); // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—è¡¨ç¤ºã‚’æ›´æ–°

      if (ytPlayer?.stopVideo) ytPlayer.stopVideo();
      isPlaying = false;
      return;
    }
    updateTimerDisplay();
  }, 1000);
}



function stopLoop() {
  ytPlayer?.pauseVideo();
  isPaused = true;
  isPlaying = false;
  clearInterval(timerInterval);
}

function resetLoop() {
  ytPlayer?.destroy();
  ytPlayer = null;
  clearInterval(timerInterval);
  remainingTime = 0;
  isPaused = false;
  isPlaying = false;
  document.getElementById("ytUrl").value = "";
  document.getElementById("duration").value = "";
  document.getElementById("timerDisplay").textContent = "";
  document.getElementById("timerDisplay").style.display = "none";
  document.getElementById("ytPlayer").innerHTML = "";

  // hide and remove circular timer if present
  const circ = document.getElementById("circularTimer");
  if (circ) {
    circ.style.display = "none";
    circ.remove();
  }
  
}


fetch("videos.json")
  .then(res => res.ok ? res.json() : Promise.reject(new Error("èª­ã¿è¾¼ã¿å¤±æ•—")))
  .then(data => { moodVideos = data; console.log("å‹•ç”»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†", moodVideos); })
  .catch(err => alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message));

function extractVideoId(url) {
  const match = url.match(/(?:youtu\.be\/|youtube\.com.*(?:v=|\/embed\/))([a-zA-Z0-9_-]+)/);
  return match ? match[1] : null;
}

function copyToLoop(url) {
  document.getElementById("ytUrl").value = url;
  showSection('loop');
  loadVideo();
}

function playRandomVideo(mood) {
  const urls = moodVideos[mood];
  if (!urls || urls.length === 0) {
    alert(currentLang === 'jp' ? "ãã®æ°—åˆ†ã®å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚" : "No videos found for that mood.");
    return;
  }
  const randomUrl = urls[Math.floor(Math.random() * urls.length)];
  const videoId = extractVideoId(randomUrl);
  if (!videoId) {
    alert(currentLang === 'jp' ? "ç„¡åŠ¹ãªå‹•ç”»URLã§ã™ã€‚" : "Invalid video URL.");
    return;
  }
  const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&playsinline=1`;
  const resultArea = document.getElementById("videoArea_choice");

  resultArea.innerHTML = `<p data-jp="ã‚ãªãŸã«ã´ã£ãŸã‚Šã®éŸ³æ¥½ã‚’å ã£ã¦ã„ã¾ã™â€¦" data-en="Fortune-telling your perfect music...">${currentLang === 'jp' ? "ã‚ãªãŸã«ã´ã£ãŸã‚Šã®éŸ³æ¥½ã‚’å ã£ã¦ã„ã¾ã™â€¦" : "Fortune-telling your perfect music..."}</p>`;

  setTimeout(() => {
    resultArea.innerHTML = `
      <div class="video-wrapper">
        <iframe src="${embedUrl}" allow="autoplay" allowfullscreen playsinline></iframe>
      </div>
      <p data-jp="ã‚ãªãŸã®ä»Šæ—¥ã®éŸ³æ¥½ã¯ã“ã¡ã‚‰ï¼" data-en="Your music for today is here!">${currentLang === 'jp' ? "ã‚ãªãŸã®ä»Šæ—¥ã®éŸ³æ¥½ã¯ã“ã¡ã‚‰ï¼" : "Your music for today is here!"}</p>
      <p>URL: <span id="copiableUrl">${randomUrl}</span></p>
      <button class="btn" onclick="copyToLoop('${randomUrl}')" data-jp="ã“ã®å‹•ç”»ã‚’Sympho loopã§ä½¿ã†" data-en="Use this video with Sympho loop">
        ${currentLang === 'jp' ? "ã“ã®å‹•ç”»ã‚’Sympho loopã§ä½¿ã†" : "Use this video with Sympho loop"}
      </button>
    `;
    updateLanguage();
    document.getElementById("videoArea_choice").scrollIntoView({ behavior: "smooth" });
  }, 2000);
}

// ---------------- ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã«è±ªè¯ãƒãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ  ----------------
document.querySelectorAll('.btn, .btnHW, #positionBtn, #langToggle').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.classList.remove('pop'); // å¿µã®ãŸã‚ä¸€åº¦å‰Šé™¤
    void btn.offsetWidth; // reflowã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    btn.classList.add('pop');
  });
});

</script>
</body>
</html>
